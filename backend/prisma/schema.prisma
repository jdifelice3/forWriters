generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentType {
  MANUSCRIPT
  FEEDBACK
}

enum ParticipantType {
  AUTHOR
  REVIEWER
}

enum EventType {
  READING
  RETREAT
}

enum Genre {
  FANTASY
  HISTORICAL
  HORROR
  LITERARY
  MYSTERY
  POEM
  ROMANCE
  SCIENCEFICTION
}

enum GroupType {
  WRITING
}

enum FileType {
  DOCX
  PDF
}

enum Role {
  ADMIN
  EDITOR
  READER
}

enum UrlOwnerType {
  USER
  WRITINGGROUP
}

enum UrlType {
  AUDIO
  FACEBOOK
  IMAGE
  LINKEDIN
  MEETUP
  SUBSTACK
  WEBSITE
  YOUTUBE
}

enum WorkType {
  FLASHFICTION
  NOVEL
  NOVELLA
  NOVELETTE
  PLAY
  SCREENPLAY
  SERIALIZEDFICTION
  SHORTSTORY
}

model AppFile {
  id                  String       @id @default(cuid())
  userId              String
  title               String
  description         String?
  filename            String
  documentType        DocumentType @default(MANUSCRIPT)
  mimetype            FileType     @default(PDF)
  url                 String
  uploadedAt          DateTime     @default(now())
  workType            WorkType?
  wordCount           Int?
  pageCount           Int?
  genre               Genre?
  manuscriptIsVisible Boolean      @default(false)

  user               User                @relation(fields: [userId], references: [id])
  readingManuscripts ReadingManuscript[]
  readingFeedback   ReadingFeedback[]
}

model Reading {
  id                  String   @id @default(cuid())
  name                String
  groupId             String
  createdAt           DateTime @default(now())
  createdUserId       String
  readingDate         DateTime
  readingStartTime    String
  readingEndTime      String
  readingAddressId    String?  @unique
  submissionDeadline  DateTime
  description         String
  minDaysBetweenReads Int      @default(20) // configurable
  maxConsecutiveReads Int      @default(1) // e.g., can't sign up twice in a row

  user                User                 @relation(fields: [createdUserId], references: [id])
  readingAuthor ReadingAuthor[]
  group              Group                @relation(fields: [groupId], references: [id])
  groupAddress       GroupAddress?        @relation(fields: [readingAddressId], references: [id])
}

model ReadingAuthor {
  id              String          @id @default(cuid())
  readingId       String
  authorId   String
  joinedAt        DateTime        @default(now())

  reading Reading @relation(fields: [readingId], references: [id])
  user    User    @relation(fields: [authorId], references: [id])
  readingManuscript  ReadingManuscript[]

  @@unique([readingId, authorId])
}

model ReadingFeedback {
  id                  String   @id @default(cuid())
  readingManuscriptId String
  feedbackFileId      String
  userId          String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  appFile             AppFile         @relation(fields: [feedbackFileId], references: [id])
  user           User       @relation(fields: [userId], references: [id])  
  readingManuscript ReadingManuscript @relation(fields: [readingManuscriptId], references: [id])

  @@unique([readingManuscriptId, userId])
}

model ReadingManuscript {
  id              String @id @default(cuid())
  readingId       String
  readingAuthorId String @unique
  appFileId       String

  readingFeedback ReadingFeedback[]
  readingAuthor         ReadingAuthor           @relation(fields: [readingId], references: [id])
  appFile         AppFile           @relation(fields: [appFileId], references: [id])
}

model Group {
  id            String    @id @default(cuid())
  creatorUserId String
  groupType     GroupType @default(WRITING)
  name          String    @unique
  description   String?
  imageUrl      String?
  websiteUrl    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  groupAddress GroupAddress[]
  groupUser    GroupUser[]
  groupNews    GroupNews[]
  reading      Reading[]
  groupUrl     GroupUrl[]
  user         User           @relation(fields: [creatorUserId], references: [id])
}

model GroupAddress {
  id     String @id @default(cuid())
  street String
  city   String
  state  String
  zip    String

  groupId String
  group   Group?   @relation(fields: [groupId], references: [id])
  reading Reading?
}

model GroupNews {
  id       String   @id @default(cuid())
  groupId  String
  title    String
  content  String?
  postedAt DateTime @default(now())
  archived Boolean  @default(false)

  group Group @relation(fields: [groupId], references: [id])
}

model GroupUser {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  isAdmin   Boolean  @default(false)
  invitedBy String?
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id])

  @@unique([groupId, userId])
}

model GroupUrl {
  id        String   @id @default(cuid())
  url       String
  groupId   String
  urlType   UrlType  @default(WEBSITE)
  createdAt DateTime @default(now())

  group Group? @relation(fields: [groupId], references: [id])
}

model User {
  id            String   @id @default(cuid())
  superTokensId String   @unique
  email         String   @unique
  role          Role     @default(EDITOR)
  username      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  groupUser          GroupUser[]
  group              Group[]
  reading            Reading[]
  userProfile        UserProfile?
  appFiles           AppFile[]
  urls               UserUrl[]
  readingAuthor     ReadingAuthor[]
  readingFeedback   ReadingFeedback[]     

}

model UserProfile {
  id        String  @id @default(cuid())
  userId    String  @unique
  firstName String?
  lastName  String?
  phone     String?
  bio       String?

  user User @relation(fields: [userId], references: [id])
}

model UserUrl {
  id        String   @id @default(cuid())
  url       String
  userId    String
  urlType   UrlType  @default(WEBSITE)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
